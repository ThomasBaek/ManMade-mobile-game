<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MadeMan.IdleEmpire.ViewModels"
             xmlns:components="clr-namespace:MadeMan.IdleEmpire.Views.Components"
             x:Class="MadeMan.IdleEmpire.Views.MainPage"
             x:DataType="vm:MainViewModel"
             BackgroundColor="{StaticResource Background}"
             Shell.NavBarIsVisible="False">

    <!-- Safe Area Container -->
    <Grid Padding="16,0,16,16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- === TOP BAR (Reusable Component) === -->
        <components:TopBar Grid.Row="0"/>

        <!-- === OPERATIONS LIST (Compact) === -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Spacing="8"
                                 BindableLayout.ItemsSource="{Binding Operations}">
                <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="vm:OperationViewModel">
                        <Frame BackgroundColor="{StaticResource Surface}"
                               CornerRadius="8"
                               Padding="10"
                               BorderColor="Transparent"
                               IsVisible="{Binding ShouldShow}">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding TapCommand}"/>
                            </Frame.GestureRecognizers>

                            <Grid ColumnDefinitions="44,*,Auto" ColumnSpacing="10">

                                <!-- Icon (compact) - using Border instead of Frame for performance -->
                                <Border BackgroundColor="{StaticResource SurfaceLight}"
                                        StrokeThickness="0"
                                        HeightRequest="44"
                                        WidthRequest="44">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="6"/>
                                    </Border.StrokeShape>
                                    <Label Text="{Binding IconEmoji}"
                                           FontSize="22"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"/>
                                </Border>

                                <!-- Info Column -->
                                <VerticalStackLayout Grid.Column="1"
                                                     VerticalOptions="Center"
                                                     Spacing="2">

                                    <!-- Name + Level Row -->
                                    <HorizontalStackLayout Spacing="6">
                                        <Label Text="{Binding Name}"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource TextPrimary}"
                                               LineBreakMode="TailTruncation"/>
                                        <Label Text="{Binding LevelDisplay}"
                                               FontSize="12"
                                               TextColor="{StaticResource TextSecondary}"/>
                                    </HorizontalStackLayout>

                                    <!-- Progress Bar (unlocked: yield progress) -->
                                    <ProgressBar Progress="{Binding Progress}"
                                                 ProgressColor="{StaticResource Gold}"
                                                 BackgroundColor="{StaticResource SurfaceLight}"
                                                 HeightRequest="6"
                                                 Margin="0,2,0,0"
                                                 IsVisible="{Binding IsUnlocked}"/>

                                    <!-- Progress Bar (locked: unlock progress) -->
                                    <Grid HeightRequest="4"
                                          IsVisible="{Binding IsUnlocked, Converter={StaticResource InverseBoolConverter}}"
                                          Margin="0,2,0,0">
                                        <BoxView BackgroundColor="{StaticResource SurfaceLight}"
                                                 CornerRadius="2"/>
                                        <BoxView BackgroundColor="{StaticResource Gold}"
                                                 CornerRadius="2"
                                                 HorizontalOptions="Start"
                                                 WidthRequest="{Binding UnlockProgress, Converter={StaticResource ProgressToWidthConverter}}"/>
                                    </Grid>

                                    <!-- Income display (unlocked only) -->
                                    <HorizontalStackLayout Spacing="6"
                                                           IsVisible="{Binding IsUnlocked}">
                                        <Label Text="{Binding YieldDisplay}"
                                               FontSize="11"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource Gold}"/>
                                        <Label Text="{Binding TimeRemainingDisplay}"
                                               FontSize="11"
                                               TextColor="{StaticResource TextSecondary}"/>
                                        <Label Text="{Binding IncomeDisplay}"
                                               FontSize="11"
                                               TextColor="{StaticResource TextSecondary}"/>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>

                                <!-- Action Button (compact) -->
                                <Button Grid.Column="2"
                                        Text="{Binding ButtonText}"
                                        Clicked="OnOperationButtonClicked"
                                        BackgroundColor="{Binding ButtonColor}"
                                        TextColor="White"
                                        CornerRadius="6"
                                        Padding="12,0"
                                        FontSize="12"
                                        FontAttributes="Bold"
                                        HeightRequest="36"
                                        MinimumWidthRequest="65"
                                        VerticalOptions="Center"/>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
            </VerticalStackLayout>
        </ScrollView>

        <!-- === SKILL SELECTION MODAL (Overlay) === -->
        <components:SkillSelectionModal Grid.RowSpan="3"/>

        <!-- === WELCOME BACK MODAL (Overlay) === -->
        <components:WelcomeBackModal x:Name="WelcomeBackModal" Grid.RowSpan="3"/>

        <!-- === PRESTIGE MODAL (Overlay) === -->
        <components:PrestigeModal x:Name="PrestigeModal" Grid.RowSpan="3"/>

        <!-- === TITLE UNLOCK MODAL (Overlay - on top) === -->
        <components:TitleUnlockModal Grid.RowSpan="3"/>

    </Grid>
</ContentPage>
