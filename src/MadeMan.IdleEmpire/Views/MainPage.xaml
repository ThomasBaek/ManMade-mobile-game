<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MadeMan.IdleEmpire.ViewModels"
             xmlns:components="clr-namespace:MadeMan.IdleEmpire.Views.Components"
             xmlns:skia="clr-namespace:SkiaSharp.Extended.UI.Controls;assembly=SkiaSharp.Extended.UI"
             x:Class="MadeMan.IdleEmpire.Views.MainPage"
             x:DataType="vm:MainViewModel"
             BackgroundColor="{StaticResource Background}"
             Shell.NavBarIsVisible="False">

    <!-- Main Container -->
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- === TOP BAR (Edge-to-edge static bar) === -->
        <components:TopBar Grid.Row="0"/>

        <!-- === OPERATIONS LIST (with padding) === -->
        <ScrollView Grid.Row="1" Padding="16,12,16,16">
            <VerticalStackLayout Spacing="8"
                                 BindableLayout.ItemsSource="{Binding Operations}">
                <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="vm:OperationViewModel">
                        <Frame BackgroundColor="{StaticResource Surface}"
                               CornerRadius="8"
                               Padding="10"
                               BorderColor="Transparent"
                               IsVisible="{Binding ShouldShow}">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding TapCommand}"/>
                            </Frame.GestureRecognizers>

                            <Grid ColumnDefinitions="44,*,Auto" ColumnSpacing="10">

                                <!-- Icon (compact) - using Border instead of Frame for performance -->
                                <Border BackgroundColor="{StaticResource SurfaceLight}"
                                        StrokeThickness="0"
                                        HeightRequest="44"
                                        WidthRequest="44">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="6"/>
                                    </Border.StrokeShape>
                                    <Label Text="{Binding IconEmoji}"
                                           FontSize="22"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"/>
                                </Border>

                                <!-- Info Column -->
                                <VerticalStackLayout Grid.Column="1"
                                                     VerticalOptions="Center"
                                                     Spacing="2">

                                    <!-- Name + Level Row -->
                                    <HorizontalStackLayout Spacing="6">
                                        <Label Text="{Binding Name}"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource TextPrimary}"
                                               LineBreakMode="TailTruncation"/>
                                        <Label Text="{Binding LevelDisplay}"
                                               FontSize="12"
                                               TextColor="{StaticResource TextSecondary}"/>
                                    </HorizontalStackLayout>

                                    <!-- Progress Bar (unlocked: yield progress) -->
                                    <ProgressBar Progress="{Binding Progress}"
                                                 ProgressColor="{StaticResource Gold}"
                                                 BackgroundColor="{StaticResource SurfaceLight}"
                                                 HeightRequest="6"
                                                 Margin="0,2,0,0"
                                                 IsVisible="{Binding IsUnlocked}"/>

                                    <!-- Potential income teaser (locked only) -->
                                    <Label Text="{Binding PotentialIncomeDisplay}"
                                           FontSize="11"
                                           TextColor="{StaticResource TextSecondary}"
                                           IsVisible="{Binding IsUnlocked, Converter={StaticResource InverseBoolConverter}}"
                                           Margin="0,2,0,0"/>

                                    <!-- Income display (unlocked only) -->
                                    <HorizontalStackLayout Spacing="6"
                                                           IsVisible="{Binding IsUnlocked}">
                                        <Label Text="{Binding YieldDisplay}"
                                               FontSize="11"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource Gold}"/>
                                        <Label Text="{Binding TimeRemainingDisplay}"
                                               FontSize="11"
                                               TextColor="{StaticResource TextSecondary}"/>
                                        <Label Text="{Binding IncomeDisplay}"
                                               FontSize="11"
                                               TextColor="{StaticResource TextSecondary}"/>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>

                                <!-- Action Button (compact) -->
                                <Button Grid.Column="2"
                                        Text="{Binding ButtonText}"
                                        Clicked="OnOperationButtonClicked"
                                        BackgroundColor="{Binding ButtonColor}"
                                        TextColor="White"
                                        CornerRadius="6"
                                        Padding="12,0"
                                        FontSize="12"
                                        FontAttributes="Bold"
                                        HeightRequest="36"
                                        MinimumWidthRequest="65"
                                        VerticalOptions="Center"/>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
            </VerticalStackLayout>
        </ScrollView>

        <!-- === SKILL SELECTION MODAL (Overlay) === -->
        <components:SkillSelectionModal Grid.RowSpan="3"/>

        <!-- === WELCOME BACK MODAL (Overlay) === -->
        <components:WelcomeBackModal x:Name="WelcomeBackModal" Grid.RowSpan="3"/>

        <!-- === PRESTIGE MODAL (Overlay) === -->
        <components:PrestigeModal x:Name="PrestigeModal" Grid.RowSpan="3"/>

        <!-- === TITLE UNLOCK MODAL (Overlay - on top) === -->
        <components:TitleUnlockModal Grid.RowSpan="3"/>

        <!-- === CELEBRATION OVERLAY (Prestige) === -->
        <!-- Screen Flash -->
        <BoxView x:Name="CelebrationFlash"
                 Grid.RowSpan="3"
                 Color="White"
                 Opacity="0"
                 IsVisible="False"
                 InputTransparent="True"/>

        <!-- Confetti Animation -->
        <skia:SKLottieView x:Name="ConfettiAnimation"
                           Grid.RowSpan="3"
                           Source="anim_confetti.json"
                           RepeatCount="0"
                           IsVisible="False"
                           InputTransparent="True"
                           HorizontalOptions="Fill"
                           VerticalOptions="Fill"/>

        <!-- Celebration Text -->
        <VerticalStackLayout Grid.RowSpan="3"
                             VerticalOptions="Center"
                             HorizontalOptions="Center"
                             InputTransparent="True"
                             Spacing="12">
            <Label x:Name="CelebrationTitle"
                   Text="PRESTIGE COMPLETE!"
                   FontFamily="BebasNeue"
                   FontSize="42"
                   TextColor="{StaticResource Gold}"
                   HorizontalOptions="Center"
                   IsVisible="False"/>
            <Label x:Name="CelebrationBonus"
                   Text="+20% INCOME BONUS!"
                   FontSize="20"
                   FontAttributes="Bold"
                   TextColor="White"
                   HorizontalOptions="Center"
                   IsVisible="False"/>
            <!-- New Title -->
            <Frame x:Name="CelebrationTitleFrame"
                   BackgroundColor="{StaticResource Surface}"
                   CornerRadius="12"
                   Padding="20,12"
                   BorderColor="{StaticResource Gold}"
                   IsVisible="False"
                   HorizontalOptions="Center">
                <VerticalStackLayout Spacing="4">
                    <Label Text="NEW TITLE UNLOCKED"
                           FontSize="10"
                           TextColor="{StaticResource TextSecondary}"
                           HorizontalOptions="Center"/>
                    <Label x:Name="CelebrationNewTitle"
                           Text="Street Thug"
                           FontFamily="BebasNeue"
                           FontSize="28"
                           TextColor="{StaticResource Gold}"
                           HorizontalOptions="Center"/>
                    <Label x:Name="CelebrationTitleDesc"
                           Text="You're making a name"
                           FontSize="12"
                           TextColor="{StaticResource TextSecondary}"
                           HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </Frame>
        </VerticalStackLayout>

    </Grid>
</ContentPage>
