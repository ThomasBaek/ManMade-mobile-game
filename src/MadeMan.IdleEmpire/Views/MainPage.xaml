<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MadeMan.IdleEmpire.ViewModels"
             xmlns:components="clr-namespace:MadeMan.IdleEmpire.Views.Components"
             x:Class="MadeMan.IdleEmpire.Views.MainPage"
             x:DataType="vm:MainViewModel"
             BackgroundColor="{StaticResource Background}"
             Shell.NavBarIsVisible="False">

    <!-- Safe Area Container -->
    <Grid Padding="16,0,16,16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- === TOP BAR (Reusable Component) === -->
        <components:TopBar Grid.Row="0"/>

        <!-- === OPERATIONS LIST (Compact) === -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Spacing="8"
                                 BindableLayout.ItemsSource="{Binding Operations}">
                <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="vm:OperationViewModel">
                        <Frame BackgroundColor="{StaticResource Surface}"
                               CornerRadius="8"
                               Padding="10"
                               BorderColor="Transparent"
                               IsVisible="{Binding ShouldShow}">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding TapCommand}"/>
                            </Frame.GestureRecognizers>

                            <Grid ColumnDefinitions="44,*,Auto" ColumnSpacing="10">

                                <!-- Icon (compact) -->
                                <Frame BackgroundColor="{StaticResource SurfaceLight}"
                                       CornerRadius="6"
                                       Padding="0"
                                       HeightRequest="44"
                                       WidthRequest="44"
                                       BorderColor="Transparent">
                                    <Label Text="{Binding IconEmoji}"
                                           FontSize="22"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"/>
                                </Frame>

                                <!-- Info Column -->
                                <VerticalStackLayout Grid.Column="1"
                                                     VerticalOptions="Center"
                                                     Spacing="2">

                                    <!-- Name + Level Row -->
                                    <HorizontalStackLayout Spacing="6">
                                        <Label Text="{Binding Name}"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource TextPrimary}"
                                               LineBreakMode="TailTruncation"/>
                                        <Label Text="{Binding LevelDisplay}"
                                               FontSize="12"
                                               TextColor="{StaticResource TextSecondary}"/>
                                    </HorizontalStackLayout>

                                    <!-- Progress Bar (unlocked: yield progress) -->
                                    <Grid HeightRequest="6"
                                          IsVisible="{Binding IsUnlocked}"
                                          Margin="0,2,0,0">
                                        <ProgressBar Progress="{Binding Progress}"
                                                     ProgressColor="{StaticResource Gold}"
                                                     BackgroundColor="{StaticResource SurfaceLight}"
                                                     HeightRequest="6"/>
                                    </Grid>

                                    <!-- Progress Bar (locked: unlock progress) -->
                                    <Grid HeightRequest="4"
                                          IsVisible="{Binding IsUnlocked, Converter={StaticResource InverseBoolConverter}}"
                                          Margin="0,2,0,0">
                                        <BoxView BackgroundColor="{StaticResource SurfaceLight}"
                                                 CornerRadius="2"/>
                                        <BoxView BackgroundColor="{StaticResource Gold}"
                                                 CornerRadius="2"
                                                 HorizontalOptions="Start"
                                                 WidthRequest="{Binding UnlockProgress, Converter={StaticResource ProgressToWidthConverter}}"/>
                                    </Grid>

                                    <!-- Income display (unlocked only) -->
                                    <HorizontalStackLayout Spacing="6"
                                                           IsVisible="{Binding IsUnlocked}">
                                        <Label Text="{Binding YieldDisplay}"
                                               FontSize="11"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource Gold}"/>
                                        <Label Text="{Binding TimeRemainingDisplay}"
                                               FontSize="11"
                                               TextColor="{StaticResource TextSecondary}"/>
                                        <Label Text="{Binding IncomeDisplay}"
                                               FontSize="11"
                                               TextColor="{StaticResource TextSecondary}"/>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>

                                <!-- Action Button (compact) -->
                                <Button Grid.Column="2"
                                        Text="{Binding ButtonText}"
                                        Command="{Binding TapCommand}"
                                        BackgroundColor="{Binding ButtonColor}"
                                        TextColor="White"
                                        CornerRadius="6"
                                        Padding="12,0"
                                        FontSize="12"
                                        FontAttributes="Bold"
                                        HeightRequest="36"
                                        MinimumWidthRequest="65"
                                        VerticalOptions="Center"/>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
            </VerticalStackLayout>
        </ScrollView>

        <!-- === PRESTIGE PANEL (Compact) === -->
        <Frame Grid.Row="2"
               BackgroundColor="{StaticResource Primary}"
               CornerRadius="10"
               Padding="12"
               Margin="0,8,0,0"
               IsVisible="{Binding CanPrestige}"
               BorderColor="Transparent">
            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                <VerticalStackLayout VerticalOptions="Center" Spacing="2">
                    <Label Text="PRESTIGE READY"
                           FontSize="13"
                           FontAttributes="Bold"
                           TextColor="White"/>
                    <Label Text="{Binding PrestigeButtonText}"
                           FontSize="11"
                           TextColor="White"
                           Opacity="0.85"/>
                </VerticalStackLayout>
                <Button Grid.Column="1"
                        Text="GO"
                        Command="{Binding PrestigeCommand}"
                        BackgroundColor="White"
                        TextColor="{StaticResource Primary}"
                        CornerRadius="6"
                        FontAttributes="Bold"
                        HeightRequest="36"
                        WidthRequest="60"/>
            </Grid>
        </Frame>

        <!-- === SKILL SELECTION MODAL (Overlay) === -->
        <components:SkillSelectionModal Grid.RowSpan="3"/>

        <!-- === WELCOME BACK MODAL (Overlay - on top) === -->
        <components:WelcomeBackModal x:Name="WelcomeBackModal" Grid.RowSpan="3"/>

    </Grid>
</ContentPage>
